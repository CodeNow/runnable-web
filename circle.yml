machine:
  environment:
    NODE_ENV: circle
dependencies:
  override:
    - java -jar ./tests/lib/selenium-server-standalone-2.41.0.jar:
        background: true
    - nvm install 0.10.25
    - nvm alias default 0.10.25
    - npm install
    - gem install compass
    - ./node_modules/.bin/bower install
    - ./node_modules/.bin/grunt build
    - node ./index.js:
        background: true
    - 'echo "$CIRCLE_BRANCH" | grep -q -w -P "(.*chef.*)|(master)"; if [ $? -eq 0 ]; then (bundle check --path=vendor/bundle || bundle install --path=vendor/bundle  --clean); fi':
        pwd: cookbook
        timeout: 99999
    - 'echo "$CIRCLE_BRANCH" | grep -q -w -P "(.*chef.*)|(master)"; if [ $? -eq 0 ]; then bundle exec berks install; fi':
        pwd: cookbook

test:
  override:
    - ./nightwatch
    - ruby -e 'if ENV[CIRCLE_BRANCH] =~ /(.*chef.*)|(master)/ exec "bundle exec rake test"': 
      pwd: cookbook
      timeout: 99999
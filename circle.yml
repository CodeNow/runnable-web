machine:
  environment:
    NODE_ENV: circle
dependencies:
  cache_directories:
    - "cookbook/vendor/bundle"
    - "node_modules"
  override:
    - java -jar ./tests/lib/selenium-server-standalone-2.41.0.jar:
        background: true
    - nvm install 0.10.25
    - nvm alias default 0.10.25
    - npm install
    - gem install compass
    - ./node_modules/.bin/bower install
    - ./node_modules/.bin/grunt build
    - node ./index.js:
        background: true
    - ruby -e 'if ENV["CIRCLE_BRANCH"] =~ /(.*chef.*)|(master)/ then exec "bundle check --path=vendor/bundle || bundle install --path=vendor/bundle --clean" end':
        pwd: cookbook
        timeout: 99999
    - ruby -e 'if ENV["CIRCLE_BRANCH"] =~ /(.*chef.*)|(master)/ then exec "bundle exec berks install" end': 
        pwd: cookbook

test:
  override:
    - ./nightwatch
    - ruby -e 'if ENV["CIRCLE_BRANCH"] =~ /(.*chef.*)|(master)/ then exec "bundle exec rake test" end': 
        pwd: cookbook
        timeout: 99999

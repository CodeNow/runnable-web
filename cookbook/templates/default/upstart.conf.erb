#!upstart
description "<%= @name %>"
author "Runnable"

env APP_DIR=<%= @deploy_path %>
env LOG_FILE=<%= @log_file %>
env NODE_ENV=<%= @node_env %>
env NODE_PATH=<%= @deploy_path %>/lib

start on (local-filesystems and net-device-up IFACE=eth0)
stop on shutdown

script
  touch $LOG_FILE
  chdir $APP_DIR
  echo $$ > /var/run/<%= @name %>.pid
  exec <%= @start_command || 'npm start' %> >> $LOG_FILE 2>&1
end script

pre-start script
  # Date format same as (new Date()).toISOString() for consistency
  echo "[`date -u +%Y-%m-%dT%T.%3NZ`] (sys) Starting" >> $LOG_FILE
end script

pre-stop script
  rm /var/run/api-server.pid
  echo "[`date -u +%Y-%m-%dT%T.%3NZ`] (sys) Stopping" >> $LOG_FILE
end script

post-start script
  echo "===== App restarted =====" >> $LOG_FILE
end script

respawn
respawn limit 5 60     # give up restart after 5 respawns in 60 seconds
